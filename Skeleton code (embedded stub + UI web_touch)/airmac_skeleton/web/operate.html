<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>V·∫≠n h√†nh | AIR MAC SMART</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <main class="container form-card">
    <h1>3. V·∫≠n h√†nh & C·∫£nh b√°o</h1>

    <!-- KPI Section -->
    <div class="kpi">
      <div class="card kpi-card">
        <div class="label">LPM</div>
        <div id="lpm" class="value">0</div>
      </div>
      <div class="card kpi-card">
        <div class="label">√Åp l·ª±c (mmHg)</div>
        <div id="pressure" class="value">0</div>
      </div>
      <div class="card kpi-card">
        <div class="label">Tr·∫°ng th√°i</div>
        <div id="status" class="value badge">-</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button id="start" class="btn primary">‚ñ∂ B·∫Øt ƒë·∫ßu</button>
      <button id="estop" class="btn danger">‚õî E-Stop</button>
      <button id="stop" class="btn secondary">‚èπ K·∫øt th√∫c & L∆∞u</button>
    </div>

    <div id="msg" class="alert" style="display:none"></div>
  </main>

<script>
const api = (p, o={}) => fetch('http://localhost:8080'+p, {
  headers:{'Content-Type':'application/json'}, ...o
}).then(r=>r.json());

const caseId = localStorage.getItem('caseId');
const el = {
  lpm: document.getElementById('lpm'),
  pressure: document.getElementById('pressure'),
  status: document.getElementById('status'),
  msg: document.getElementById('msg')
};

async function refresh() {
  try {
    const r = await api(`/api/cases/${caseId}/status`);
    if (r.status) {
      el.status.textContent = r.status;
      el.status.className = "value badge " + r.status;
      el.lpm.textContent = r.device?.lpm?.toFixed(2) ?? '0';
      el.pressure.textContent = r.device?.pressure?.toFixed(1) ?? '0';
    }
  } catch {}
}
setInterval(refresh, 1000);

document.getElementById('start').onclick = async ()=>{
  const r = await api(`/api/cases/${caseId}/start`, { method:'POST' });
  if (r.ok) { el.msg.style.display='block'; el.msg.textContent = '‚úÖ ƒê√£ b·∫Øt ƒë·∫ßu b∆°m.'; }
};
document.getElementById('estop').onclick = async ()=>{
  const r = await api(`/api/cases/${caseId}/estop`, { method:'POST' });
  if (r.ok) { el.msg.style.display='block'; el.msg.textContent = '‚õî ƒê√£ E-Stop & x·∫£ √°p.'; }
};
document.getElementById('stop').onclick = async ()=>{
  const r = await api(`/api/cases/${caseId}/complete`, { method:'POST' });
  if (r.ok) { el.msg.style.display='block'; el.msg.textContent = 'üìÅ ƒê√£ l∆∞u ca. C√≥ th·ªÉ xu·∫•t b√°o c√°o t·ª´ server.'; }
};
</script>
</body>
</html>
